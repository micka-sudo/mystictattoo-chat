name: Déploiement continu NAS

on:
  push:
    branches:
      - master
      - staging
      - releasecss002

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout du code
        uses: actions/checkout@v3

      - name: Installer les dépendances
        run: npm install

      - name: Build du projet
        run: npm run build

      - name: Vérifier que le build est valide
        run: |
          if [ ! -d "build" ]; then
            echo "❌ Le dossier 'build/' n'existe pas. Échec du build."
            exit 1
          fi

          FILES=$(find build -type f \( -name "*.html" -o -name "*.js" -o -name "*.css" \))
          if [ -z "$FILES" ]; then
            echo "❌ Aucun fichier HTML/JS/CSS trouvé dans build/. Échec du build."
            exit 1
          fi

          echo "✅ Build valide. Fichiers trouvés dans le dossier build/"

      - name: Choisir le dossier de destination
        id: set-path
        run: |
          if [[ "${{ github.ref }}" == "refs/heads/master" ]]; then
            echo "DEPLOY_PATH=/volume1/web/mystictattoo" >> $GITHUB_ENV
          elif [[ "${{ github.ref }}" == "refs/heads/staging" ]]; then
            echo "DEPLOY_PATH=/volume1/web/mystictattoo-test" >> $GITHUB_ENV
          else
            echo "DEPLOY_PATH=/volume1/web/mystictattoo-dev" >> $GITHUB_ENV
          fi

      - name: Nettoyer le dossier cible sur le NAS
          uses: appleboy/ssh-action@master
          with:
            host: ${{ secrets.DEPLOY_HOST }}
            username: ${{ secrets.DEPLOY_USER }}
            key: ${{ secrets.DEPLOY_SSH_KEY }}
            script: |
              echo "🧹 Suppression des anciens fichiers sur le NAS dans ${{ env.DEPLOY_PATH }}"
              rm -rf ${{ env.DEPLOY_PATH }}/*

      - name: Déployer via SCP
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          source: "build/*"
          target: ${{ env.DEPLOY_PATH }}
          debug: true
